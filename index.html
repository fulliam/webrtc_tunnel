<!-- webrtc_manual.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>WebRTC Manual signaling (copy-paste)</title>
  <style>
    body { font-family: Arial; padding: 12px; max-width:900px; }
    textarea { width:100%; height:140px; }
    video { width: 45%; border:1px solid #ccc; margin:6px; }
    .row { display:flex; gap:10px; align-items:flex-start; }
    button { margin:6px 0; }
  </style>
</head>
<body>
  <h2>WebRTC — ручной обмен (offer/answer)</h2>

  <div>
    <label>Локальное видео</label><br/>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <hr/>

  <div>
    <button id="startBtn">Start camera</button>
    <button id="createOfferBtn">Create Offer</button>
    <button id="applyRemoteDescBtn">Apply Remote SDP</button>
  </div>

  <div>
    <h3>Local SDP / Offer (копировать и отправить)</h3>
    <textarea id="localSDP" readonly placeholder="Здесь появится offer/answer, когда ICE соберётся"></textarea>
  </div>

  <div>
    <h3>Remote SDP / Paste сюда</h3>
    <textarea id="remoteSDP" placeholder="Вставьте JSON с remoteDescription (offer/answer) и нажмите Apply"></textarea>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const createOfferBtn = document.getElementById('createOfferBtn');
    const applyRemoteDescBtn = document.getElementById('applyRemoteDescBtn');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const localSDP = document.getElementById('localSDP');
    const remoteSDP = document.getElementById('remoteSDP');

    // Используем публичный STUN Google
    const pcConfig = { 
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
      ] 
    };

    let pc = null;
    let localStream = null;

    async function startCamera(){
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        localVideo.srcObject = localStream;
        console.log('Camera started');
      } catch (e) {
        alert('Ошибка доступа к камере/микрофону: ' + e.message);
      }
    }

    function createPeerConnection(){
      pc = new RTCPeerConnection(pcConfig);

    // если локальный стрим ещё нет, добавим транссиверы для приёма
    if (!localStream) {
      try {
        pc.addTransceiver('video', { direction: 'recvonly' });
        pc.addTransceiver('audio', { direction: 'recvonly' });
      } catch (err) {
        console.warn('addTransceiver not supported:', err);
      }
    }

      // remote stream
      pc.ontrack = (evt) => {
        // присоединяем первый поток
        if (remoteVideo.srcObject !== evt.streams[0]) {
          remoteVideo.srcObject = evt.streams[0];
          console.log('Remote stream set');
        }
      };

      // логирование кандидатов (мы ждём iceGatheringState === 'complete')
      pc.onicecandidate = (evt) => {
        console.log('ICE candidate event:', evt.candidate);
      };

      pc.onicegatheringstatechange = () => {
        console.log('iceGatheringState:', pc.iceGatheringState);
        if (pc.iceGatheringState === 'complete') {
          // когда сбор ICE завершён, локальное description содержит кандидаты -> можно копировать
          localSDP.value = JSON.stringify(pc.localDescription);
        }
      };

      // добавить локальные треки
      if (localStream) {
        for (const t of localStream.getTracks()) {
          pc.addTrack(t, localStream);
        }
      }

      // На всякий случай очистим текст
      localSDP.value = '';
      remoteSDP.value = '';
    }

    // Создать offer и дождаться ICE complete
    async function createOffer(){
      createPeerConnection();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      console.log('Set local description (offer). waiting for ICE to gather...');
      // Если iceGathering уже complete — сразу покажем
      if (pc.iceGatheringState === 'complete') {
        localSDP.value = JSON.stringify(pc.localDescription);
      } else {
        localSDP.value = 'Сбор кандидатов... подождите, когда поле заполнится автоматически.';
      }
    }

    // Применить удалённое описание (offer или answer)
    async function applyRemoteDescription(){
      const text = remoteSDP.value.trim();
      if (!text) return alert('Вставьте удалённое SDP JSON');
      let obj;
      try {
        obj = JSON.parse(text);
      } catch (e) {
        return alert('Ошибка парсинга JSON: ' + e.message);
      }

      if (!pc) {
        // если мы получили offer — создаём pc, добавляем локальные треки и создаём answer
        createPeerConnection();
      }

      await pc.setRemoteDescription(new RTCSessionDescription(obj));
      console.log('Remote description set');

      if (obj.type === 'offer') {
        // если это offer — создаём answer и ждём ICE
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        if (pc.iceGatheringState === 'complete') {
          localSDP.value = JSON.stringify(pc.localDescription);
        } else {
          localSDP.value = 'Сбор кандидатов... подождите...';
        }
      } else {
        // если это answer — всё должно подключиться
        console.log('Applied remote answer; connection in progress');
      }
    }

    // Привязки
    startBtn.onclick = startCamera;
    createOfferBtn.onclick = createOffer;
    applyRemoteDescBtn.onclick = applyRemoteDescription;
  </script>
</body>
</html>
