<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebRTC Manual signaling (responsive)</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#667085;
      --accent:#2563eb;
      --success:#16a34a;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.6);
      font-family: Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;
    }

    *{box-sizing:border-box}
    body{margin:0; padding:18px; background:linear-gradient(180deg,#f6f8fb 0%,#eef2ff 100%); color:#0f172a}
    .wrap{max-width:980px; margin:0 auto}
    header{display:flex;gap:12px;align-items:center; margin-bottom:10px}
    header h1{font-size:1.05rem; margin:0}
    header p{margin:0; color:var(--muted); font-size:0.9rem}

    .card{background:var(--card); border-radius:14px; box-shadow:0 6px 20px rgba(16,24,40,0.06); padding:14px; margin-bottom:14px}

    /* Video area */
    .video-row{display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap}
    .video-card{flex:1 1 320px; min-width:260px; background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4)); border-radius:10px; padding:8px; display:flex; flex-direction:column; align-items:center}
    video{width:100%; height:auto; border-radius:8px; background:#000; max-height:360px; object-fit:cover}
    .video-label{width:100%; display:flex; justify-content:space-between; align-items:center; gap:8px; margin:8px 0 0 0}
    .dot{width:10px;height:10px;border-radius:50%}

    /* Controls */
    .controls{display:flex; flex-wrap:wrap; gap:10px}
    button{background:var(--accent); color:white; border:0; border-radius:10px; padding:12px 14px; font-size:0.95rem; min-height:44px; cursor:pointer; box-shadow:0 6px 18px rgba(37,99,235,0.12)}
    button.secondary{background:transparent; color:var(--accent); border:1px solid rgba(37,99,235,0.12); box-shadow:none}
    button.ghost{background:transparent; color:var(--muted); border:1px solid rgba(15,23,42,0.04)}
    button:disabled{opacity:0.6; cursor:not-allowed; filter:grayscale(0.2)}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }

    textarea{width:100%; min-height:140px; resize:vertical; padding:12px; border-radius:10px; border:1px solid rgba(15,23,42,0.06); font-family:monospace; font-size:0.85rem}

    .row{display:flex; gap:8px; align-items:center}
    .row .btn{flex:0 0 auto}
    .row .grow{flex:1}

    .muted{color:var(--muted); font-size:0.9rem}
    .status{font-size:0.9rem; padding:8px 10px; border-radius:8px; display:inline-block}
    .status.info{background:rgba(37,99,235,0.08); color:var(--accent)}
    .status.ok{background:rgba(16,185,129,0.08); color:var(--success)}
    .status.err{background:rgba(239,68,68,0.08); color:var(--danger)}

    .small{font-size:0.82rem}
    .controls-wrap{display:flex; gap:12px; flex-wrap:wrap; margin-top:6px}

    /* Copy button inside text area header */
    .area-header{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px}
    .actions{display:flex; gap:8px; align-items:center}

    footer{font-size:0.8rem; color:var(--muted); text-align:center; margin-top:6px}

    /* Make clickable area larger for small touch devices */
    .touch-large{padding:12px 16px; border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>WebRTC — ручной обмен (offer/answer)</h1>
      </div>
    </header>

    <div class="card">
      <div class="video-row">
        <div class="video-card">
          <div class="video-label"><strong>Локальное видео</strong><span class="muted small">(выключено, нажмите "Start")</span></div>
          <video id="localVideo" autoplay muted playsinline></video>
        </div>

        <div class="video-card">
          <div class="video-label"><strong>Удалённое видео</strong><span class="muted small">(ждём подключения)</span></div>
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </div>

      <div class="controls-wrap">
        <div class="controls">
          <button id="startBtn" class="touch-large">Start camera</button>
          <button id="stopBtn" class="touch-large secondary" disabled>Stop camera</button>
          <button id="createOfferBtn" class="touch-large">Create Offer</button>
          <button id="applyRemoteDescBtn" class="touch-large ghost">Apply Remote SDP</button>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <div id="iceStatus" class="status info" aria-live="polite">ICE: idle</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="area-header">
          <h3 style="margin:0">Local SDP / Offer (копировать и отправить)</h3>
          <div class="actions">
            <button id="copyLocalBtn" class="touch-large ghost" title="Копировать локальное SDP" disabled>Copy</button>
            <button id="downloadLocalBtn" class="touch-large ghost" title="Скачать локальное SDP" disabled>Download</button>
          </div>
        </div>
        <textarea id="localSDP" readonly placeholder="Здесь появится offer/answer, когда ICE соберётся"></textarea>
      </div>

      <div class="card">
        <div class="area-header">
          <h3 style="margin:0">Remote SDP / Paste сюда</h3>
          <div class="actions">
            <button id="pasteRemoteBtn" class="touch-large ghost" title="Вставить из буфера обмена">Paste</button>
            <button id="copyRemoteBtn" class="touch-large ghost" title="Скопировать удалённый SDP">Copy</button>
          </div>
        </div>
        <textarea id="remoteSDP" placeholder="Вставьте JSON с remoteDescription (offer/answer) и нажмите Apply"></textarea>
      </div>
    </div>

    <div class="card small">
      <div class="row" style="justify-content:space-between; align-items:center; gap:12px;">
        <div class="muted">Подсказка: можно копировать/вставлять SDP через буфер обмена или отправить по мессенджеру.</div>
        <div class="muted">Поддерживаются современные браузеры (Chrome/Edge/Firefox/Safari Mobile).</div>
      </div>
    </div>
  </div>

  <script>
    // Элементы
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const createOfferBtn = document.getElementById('createOfferBtn');
    const applyRemoteDescBtn = document.getElementById('applyRemoteDescBtn');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const localSDP = document.getElementById('localSDP');
    const remoteSDP = document.getElementById('remoteSDP');
    const copyLocalBtn = document.getElementById('copyLocalBtn');
    const copyRemoteBtn = document.getElementById('copyRemoteBtn');
    const downloadLocalBtn = document.getElementById('downloadLocalBtn');
    const pasteRemoteBtn = document.getElementById('pasteRemoteBtn');
    const iceStatus = document.getElementById('iceStatus');

    const pcConfig = { 
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
      ] 
    };

    let pc = null;
    let localStream = null;

    function setStatus(text, kind='info'){
      iceStatus.textContent = text;
      iceStatus.className = 'status ' + (kind==='info'? 'info' : kind==='ok' ? 'ok' : 'err');
    }

    async function startCamera(){
      try {
        startBtn.disabled = true;
        setStatus('Запрос разрешений...');
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        localVideo.srcObject = localStream;
        setStatus('Камера запущена', 'ok');
        stopBtn.disabled = false;
      } catch (e) {
        alert('Ошибка доступа к камере/микрофону: ' + (e.message || e));
        setStatus('Ошибка доступа к камере', 'err');
        startBtn.disabled = false;
      }
    }

    function stopCamera(){
      if (localStream) {
        for (const t of localStream.getTracks()) t.stop();
        localStream = null;
        localVideo.srcObject = null;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setStatus('Камера остановлена');
    }

    function createPeerConnection(){
      pc = new RTCPeerConnection(pcConfig);

      pc.ontrack = (evt) => {
        if (remoteVideo.srcObject !== evt.streams[0]) {
          remoteVideo.srcObject = evt.streams[0];
          console.log('Remote stream set');
        }
      };

      pc.onicecandidate = (evt) => {
        console.log('ICE candidate event:', evt.candidate);
      };

      pc.onicegatheringstatechange = () => {
        console.log('iceGatheringState:', pc.iceGatheringState);
        setStatus('ICE: ' + pc.iceGatheringState);
        if (pc.iceGatheringState === 'complete') {
          localSDP.value = JSON.stringify(pc.localDescription);
          copyLocalBtn.disabled = false;
          downloadLocalBtn.disabled = false;
          setStatus('ICE собран — можно копировать SDP', 'ok');
        }
      };

      // add transceivers if no local stream
      if (!localStream) {
        try {
          pc.addTransceiver('video', { direction: 'recvonly' });
          pc.addTransceiver('audio', { direction: 'recvonly' });
        } catch (err) { console.warn('addTransceiver not supported', err); }
      }

      if (localStream) {
        for (const t of localStream.getTracks()) pc.addTrack(t, localStream);
      }

      localSDP.value = '';
      remoteSDP.value = '';
    }

    async function createOffer(){
      createPeerConnection();
      setStatus('Создаём offer...');
      try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        setStatus('Set local description (offer). Ждём ICE...');
        if (pc.iceGatheringState === 'complete') {
          localSDP.value = JSON.stringify(pc.localDescription);
          copyLocalBtn.disabled = false; downloadLocalBtn.disabled = false;
        } else {
          localSDP.value = 'Сбор кандидатов... подождите, поле заполнится автоматически.';
        }
      } catch (err) {
        console.error(err);
        setStatus('Ошибка при создании offer', 'err');
      }
    }

    async function applyRemoteDescription(){
      const text = remoteSDP.value.trim();
      if (!text) return alert('Вставьте удалённое SDP JSON');
      let obj;
      try { obj = JSON.parse(text); } catch (e) { return alert('Ошибка парсинга JSON: ' + e.message); }

      if (!pc) createPeerConnection();

      try {
        await pc.setRemoteDescription(new RTCSessionDescription(obj));
        console.log('Remote description set');

        if (obj.type === 'offer') {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          if (pc.iceGatheringState === 'complete') {
            localSDP.value = JSON.stringify(pc.localDescription);
            copyLocalBtn.disabled = false; downloadLocalBtn.disabled = false;
          } else {
            localSDP.value = 'Сбор кандидатов... подождите...';
          }
        } else {
          setStatus('Remote answer applied — соединение устанавливается', 'ok');
        }
      } catch (err) {
        console.error(err);
        alert('Ошибка при применении remote description: ' + (err.message || err));
        setStatus('Ошибка при применении remote SDP', 'err');
      }
    }

    // Copy helpers (Clipboard API + fallback)
    async function copyText(text){
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        } else {
          const ta = document.createElement('textarea');
          ta.value = text; document.body.appendChild(ta);
          ta.select(); ta.setSelectionRange(0, ta.value.length);
          document.execCommand('copy'); document.body.removeChild(ta);
          return true;
        }
      } catch (e) { console.warn('copy failed', e); return false; }
    }

    copyLocalBtn.addEventListener('click', async ()=>{
      if (!localSDP.value) return;
      const ok = await copyText(localSDP.value);
      if (ok) {
        setStatus('Local SDP copied to clipboard', 'ok');
      } else setStatus('Не удалось скопировать', 'err');
    });

    copyRemoteBtn.addEventListener('click', async ()=>{
      if (!remoteSDP.value) return;
      const ok = await copyText(remoteSDP.value);
      if (ok) setStatus('Remote SDP copied', 'ok'); else setStatus('Не удалось скопировать', 'err');
    });

    pasteRemoteBtn.addEventListener('click', async ()=>{
      try {
        if (navigator.clipboard && navigator.clipboard.readText) {
          const txt = await navigator.clipboard.readText();
          remoteSDP.value = txt;
          setStatus('Вставлено из буфера обмена');
        } else {
          setStatus('Clipboard API недоступен в этом браузере', 'err');
        }
      } catch (e) { console.error(e); setStatus('Ошибка доступа к буферу обмена', 'err'); }
    });

    downloadLocalBtn.addEventListener('click', ()=>{
      if (!localSDP.value) return;
      const blob = new Blob([localSDP.value], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'webrtc_local_sdp.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Small UX: enable copyRemote only when there's text
    remoteSDP.addEventListener('input', ()=>{ copyRemoteBtn.disabled = !remoteSDP.value.trim(); });

    // Bindings
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    createOfferBtn.addEventListener('click', createOffer);
    applyRemoteDescBtn.addEventListener('click', applyRemoteDescription);

    // Initialize smaller things
    copyRemoteBtn.disabled = true;
    copyLocalBtn.disabled = true;
    downloadLocalBtn.disabled = true;
    setStatus('ICE: idle');

    // Make buttons more responsive on touch devices by preventing double-tap zoom
    document.addEventListener('touchstart', function(){}, {passive:true});
  </script>
</body>
</html>